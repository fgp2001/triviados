
<div class = "container">
    <div class = "login-box">
        <img src="../media/back.png" alt="volver" class="back-btn" style="cursor:pointer;" onclick="history.back()">
        <h2> Registrarme </h2>
        <form action="/triviados/Register/registrar" method="POST" enctype="multipart/form-data">
            <input type="text" name="nombre" placeholder="Nombre completo" required>

            <input type="date" name="date"required>

            <select name="sexo" required>
                <option value="">Selecciona tu sexo</option>
                <option value="femenino">Femenino</option>
                <option value="masculino">Masculino</option>
                <option value="no-especificado">Prefiero no cargarlo</option>
            </select>

            <!-- Ingreso del mapa -->
            <label for="map">Ubicación de tu País y Ciudad:</label>
            <div id="map" style="height: 300px; width: 100%; border-radius: 10px; margin-bottom: 15px;"></div>
            <input type="text" name="pais" id="pais" placeholder="País" required readonly>
            <input type="text" name="ciudad" id="ciudad" placeholder="Ciudad" required readonly>

            <input type="email" name="email" id="email" placeholder="Email" required>
            <span id="email-error" style="color: red; display: none;">Este email ya está registrado</span>
            <input type="password" name="password" placeholder="Contraseña" required>
            <input type="password" name="password2" placeholder="Repetir contraseña" required>
            <input type="text" name="usuario" placeholder="Nombre de usuario" required>

            <label for="foto" class = "tituloFoto">Foto de perfil:</label>
            <input type="file" name="foto" id="foto" accept="image/*">

            <button type="submit" value="Submit">Registrarme</button>
        </form>
    </div>
</div>
<script>
    // Inicializar el mapa
    var map = L.map('map').setView([0, 0], 2); // vista inicial global

    // Cargar mapa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Agregar marcador al hacer clic
    var marker;

    map.on('click', function (e) {
        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker(e.latlng).addTo(map);

        // Usar servicio de geocodificación inversa (OpenStreetMap)
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(res => res.json())
                .then(data => {
                    const ciudad = data.address.city || data.address.town || data.address.village || '';
                    const pais = data.address.country || '';
                    document.getElementById('ciudad').value = ciudad;
                    document.getElementById('pais').value = pais;
                });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const emailInput = document.getElementById("email");
        const errorMsg = document.getElementById("email-error");
        const submitBtn = document.querySelector("form button[type='submit']");

        emailInput.addEventListener("blur", function () {
            const email = emailInput.value;

            if (email.length > 5) {
                fetch("/triviados/Register/validarEmailAjax", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "email=" + encodeURIComponent(email)
                })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.disponible) {
                                emailInput.style.border = "2px solid red";
                                errorMsg.style.display = "inline";
                                submitBtn.disabled = true;
                            } else {
                                emailInput.style.border = "2px solid green";
                                errorMsg.style.display = "none";
                                submitBtn.disabled = false;
                            }
                        });
            }
        });
    });
</script>
